%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Include tikz file.
%
% Author(s): Guillaume Dolle <gdolle at unistra.fr>
% (c) GNU GPLv2 2015
%
% Package required: package calc
% Options: scale, scalefnt
% Package options: external
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}[2014/05/01]
\ProvidesPackage{includetikz}[2015/05/01 Smart tikz include package]
\RequirePackage{ifthen}
\RequirePackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{external}
\RequirePackage{scalefnt}
\RequirePackage{xkeyval}

% Enable external tikz (pdf) with checksum.
\DeclareOption{external}
{
  \tikzexternalize
  \tikzexternaldisable
}
% Optimize
\DeclareOption{optimize}
{
  \tikzset{external/optimize=true}
}

%\tikzsetexternalprefix{work/}
\tikzexternaldisable

\makeatletter
% Parameters
\define@key{includetikz}{scale}{\tikzset{every picture/.style={scale=#1}}}
\define@key{includetikz}{width}{\tikzset{every picture/.style={width=#1}}}
\define@key{includetikz}{height}{\tikzset{every picture/.style={height=#1}}}
\define@key{includetikz}{fill opacity}{\tikzset{every picture/.style={fill opacity=#1}}}
\define@key{includetikz}{font style}{\tikzset{every picture/.style={font=#1}}}
\define@key{includetikz}{font scale}{\scalefont{#1}}
\define@key{includetikz}{drawscale}{
    \pgfmathsetmacro{\fs}{2 - #1}
    \scalefont{\fs}
    \tikzset{every picture/.style={scale=#1}}
}

\newboolean{noincludetikz}
\setboolean{noincludetikz}{false}

\newcommand\includetikz[2][]
{
  \ifthenelse{\boolean{noincludetikz}}
  {
    % Add default image
    \begin{tikzpicture}
      \draw[fill=black] (-3.5,2.5) rectangle (3.5,-2);
      \node[color=white] at (0,0.5){\large FIGURE DISABLED !};
      \node[color=white] at (0,0){\tiny\textit{(remove
          \textbackslash{}includetikzdisable} to
           reactivate this figure)};
    \end{tikzpicture}
  }
  {
    \newwrite\tempfile
    \immediate\openout\tempfile=figs/toto
    \immediate\closeout\tempfile

    \filename@parse{#2}

    % Create a counter for renaming.
    % Note that tikz external might provide this value...
    \ifcsname c@\filename@base\endcsname
      % Counter defined.
      \stepcounter{\filename@base}
      \message{\arabic{\filename@base}}
    \else
      % counter not defined.
      \newcounter{\filename@base}
      \message{\arabic{\filename@base}}
    \fi

    \bgroup

    % Set PDF path and filename.
    \def\pdffilename{\filename@base-\jobname-n\arabic{\filename@base}}
    \def\pdfoptmdfivefilename{\pdffilename-opts.md5}

    \tikzsetexternalprefix{\filename@area}
    \tikzsetnextfilename{\pdffilename}

    % Set figure options.
    \setkeys{includetikz}{#1}

    % Create MD5 for includetikz options
    % Note: Required to take into account options in the mdf5sum.
    \newwrite\tempfile
    \immediate\openout\tempfile=\filename@area\pdfoptmdfivefilename
    \message{OPTS: #1}
    \message{MD5SUM: \pdf@mdfivesum{#1}}
    \immediate\write\tempfile{md5sum:\pdf@mdfivesum{#1}}
    \immediate\closeout\tempfile
    % TODO if fileexist read it and compare current checksum, if different force
    % recompile

    \tikzexternalenable
    % Set path and auto-generated figure name.
    \input{#2}
    \tikzexternaldisable
    \egroup
  }
}

\newcommand\includetikzdisable
{
  \setboolean{noincludetikz}{true}
}

\makeatother

\ProcessOptions\relax

% vim: set ft=tex tw=80 sw=2:
