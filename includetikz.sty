%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Include tikz file.
%
% Author(s): Guillaume Dolle <gdolle at unistra.fr>
% (c) GNU GPLv2 2015
%
% Package required: package calc
% Options: scale, scalefnt
% Package options: external
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\NeedsTeXFormat{LaTeX2e}[2014/05/01]
\ProvidesPackage{includetikz}[2015/05/01 Smart tikz include package]
\RequirePackage{ifthen}
\RequirePackage{tikz}
\usetikzlibrary{calc}
\usetikzlibrary{external}
\RequirePackage{scalefnt}
\RequirePackage{xkeyval}
\RequirePackage{ifluatex}
\RequirePackage{xstring}

% Enable external tikz (pdf) with checksum.
\DeclareOption{external}
{
  \tikzexternalize
  \tikzexternaldisable
}
% Optimize
\DeclareOption{optimize}
{
  \tikzset{external/optimize=true}
}

%\tikzsetexternalprefix{work/}
\tikzexternaldisable

\makeatletter
% Parameters
\define@key{includetikz}{scale}{\tikzset{every picture/.style={scale=#1}}}
\define@key{includetikz}{keepratio}[1]{\tikzset{every node/.style={transform shape}}}
\define@key{includetikz}{width}{\tikzset{every picture/.style={width=#1}}}
\define@key{includetikz}{height}{\tikzset{every picture/.style={height=#1}}}
\define@key{includetikz}{fill opacity}{\tikzset{every picture/.style={fill opacity=#1}}}
\define@key{includetikz}{font style}{\tikzset{every picture/.style={font=#1}}}
\define@key{includetikz}{font scale}{\scalefont{#1}}
\define@key{includetikz}{drawscale}{
    \pgfmathsetmacro{\fs}{2 - #1}
    \scalefont{\fs}
    \tikzset{every picture/.style={scale=#1}}
}

\newboolean{noincludetikz}
\setboolean{noincludetikz}{false}

\newcommand\includetikz[2][]
{
  \ifthenelse{\boolean{noincludetikz}}
  {
    % Add default image
    \begin{tikzpicture}
      \draw[fill=black] (-3.5,2.5) rectangle (3.5,-2);
      \node[color=white] at (0,0.5){\large FIGURE DISABLED !};
      \node[color=white] at (0,0){\tiny\textit{(remove
          \textbackslash{}includetikzdisable} to
           reactivate this figure)};
    \end{tikzpicture}
  }
  {
    \bgroup
    \filename@parse{#2}

    % Create a counter for renaming.
    % Note that tikz external might provide this value...
    \def\countername{it\filename@base}
    \ifcsname c@\countername \endcsname
      % Counter defined.
      \stepcounter{\countername}
    \else
      % counter not defined.
      \newcounter{\countername}
    \fi

    % Vars.
    \def\pdffilename{\filename@base-\jobname-n\arabic{\countername}}

    % Set tikz external path and filename.
    \tikzsetexternalprefix{\filename@area}
    \tikzsetnextfilename{\pdffilename}

    % Set figure options.
    \setkeys{includetikz}{#1}

    % Force rebuild if includetikz option change.
    % We need to create a new MD5 for includetikz options as it is not taken
    % into account by tikz external.

    % Vars
    \def\pdfoptsmdfivefilename{\pdffilename-opts.md5}
    \def\pdfoptsmdfivefullpath{\filename@area\pdfoptsmdfivefilename}
    \newcommand\pdfoptsmdfivesum{\pdf@mdfivesum{#1}}
    \newboolean{tikzrebuild}
    \setboolean{tikzrebuild}{false}

    \immediate\message{-----------------^^J}
    \immediate\message{Processing image \pdffilename ^^J}
    \immediate\message{Processing md5 opts \pdfoptsmdfivefilename ^^J}

    % Function to write MD5 file
    \newcommand\storemdfive
    {
      \ifluatex
        \directlua{
          out = io.open('\pdfoptsmdfivefullpath','w')
          out:write('\string\\def\string\\includetikzoptslastkey{\pdfoptsmdfivesum}')
          io.close(out)
        }
      \else
        \newwrite\tempfile
        \immediate\openout\tempfile=\pdfoptsmdfivefullpath
        \immediate\write\tempfile{\@backslashchar def \@backslashchar includetikzoptslastkey{\pdfoptsmdfivesum}\@percentchar}
        \immediate\closeout\tempfile

% TODO Bug here to fix! It seems that options are modified for different
% pictures simultaneously, only the first picture is rebuild, because the MD5 cache is overwritten
% too early! (first mddivewrite call, that is unexpected => newwrite bug?)

%        \expandafter\newwrite\csname \countername\the\value{\countername}@\endcsname
%        \immediate\openout\csname \countername\the\value{\countername}@\endcsname=\pdfoptsmdfivefullpath
%        \immediate\write\csname \countername\the\value{\countername}@\endcsname{\@backslashchar def \@backslashchar includetikzoptslastkey{\pdfoptsmdfivesum}\@percentchar}
%        \immediate\closeout\csname \countername\the\value{\countername}@\endcsname
%        \immediate\write18{read}
      \fi
    }

    % Check md5file and force rebuild.
    \IfFileExists{\pdfoptsmdfivefullpath}
    {% MD5 file exist.
      \input{\pdfoptsmdfivefullpath} % load md5 opts
      \message{old:\includetikzoptslastkey, opt:#1}
      \message{new:\pdfoptsmdfivesum ^^J}
      \ifnum\pdf@strcmp{\includetikzoptslastkey}{\pdfoptsmdfivesum}=0
        % Same MD5.
        \message{SAME MD5}
      \else
        % Different MD5, force rebuild tikz.
        \message{NOT SAME MD5}
        \setboolean{tikzrebuild}{true}
        \storemdfive
      \fi
      \ifthenelse{\boolean{tikzrebuild}} %use this -> ifnum tikzset bug??
      {
        \tikzset{external/force remake=true}
      }
      {}
    }
    {
      % MD5 file does not exist.
      \storemdfive
    }

    \tikzexternalenable
    % Set path and auto-generated figure name.
    \input{#2}
    \tikzexternaldisable
    \tikzset{external/force remake=false}
    \egroup
  }
}

\newcommand\includetikzdisable
{
  \setboolean{noincludetikz}{true}
}

\makeatother

\ProcessOptions\relax

% vim: set ft=tex tw=80 sw=2:
